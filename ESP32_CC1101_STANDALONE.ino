#define LILYGO_MINI_EPAPER_ESP32
// esp32s3-fn4r2
// #define LILYGO_MINI_EPAPER_ESP32S3
#if !defined(LILYGO_MINI_EPAPER_ESP32S3)  && !defined(LILYGO_MINI_EPAPER_ESP32)
// 请在草图上方选择对应的目标板子名称,将它取消注释.
#error "Please select the corresponding target board name above the sketch and uncomment it."
#endif

#define SEND_PWM_BY_TIMER


#include <Arduino.h>
#include <Adafruit_GFX.h>
#include <GxEPD.h>
#include <boards.h>
#include <GxGDGDEW0102T4/GxGDGDEW0102T4.h> //1.02" b/w
#include GxEPD_BitmapExamples
// FreeFonts from Adafruit_GFX
#include <Fonts/FreeMonoBold9pt7b.h>
#include <Fonts/FreeMonoBold12pt7b.h>
#include <Fonts/FreeMonoBold18pt7b.h>
#include <GxIO/GxIO_SPI/GxIO_SPI.h>
#include <GxIO/GxIO.h>
// Radio Library
#include <ELECHOUSE_CC1101_SRC_DRV.h>
#include <savant128x80.h>


// M1101
#define PIN_GDO0 25 //; backpack 25
#define PIN_GDO2 27 //

// BUTTONS
#define THRESHOLD_BTN_CLICK 4000
#define PIN_BTN_1 39 // epaper mini buttons
#define PIN_BTN_2 36 // epaper mini buttons
#define PIN_BTN_3 0  // epaper mini buttons

// LED
//#define PIN_LED_RX -1
//#define PIN_LED_TX -1
//#define PIN_LED_ONBOARD -1

#define LENGTH_SAMPLES_SIGNAL_1 2048
#define LENGTH_SAMPLES_SIGNAL_2 2048
#define LENGTH_SAMPLES_SIGNAL_3 1181

// converted sub files
int samples_signal_1[LENGTH_SAMPLES_SIGNAL_1] = {1500,399,377,32700,662,391,400,389,438,385,408,387,408,387,408,387,408,385,408,387,408,387,408,387,410,387,408,387,410,387,1170,419,410,385,376,815,778,415,384,811,778,811,782,425,376,797,802,799,794,797,796,797,794,797,796,401,380,799,392,407,794,801,402,365,820,403,396,789,404,395,394,393,794,407,396,397,396,791,406,415,768,787,396,409,796,801,800,403,368,423,398,393,396,791,406,395,788,407,396,791,1192,409,404,379,406,803,776,413,384,805,786,789,822,399,382,793,786,821,792,797,794,795,796,793,796,397,380,795,404,411,802,773,406,379,798,411,396,793,408,395,394,395,794,407,394,395,396,791,404,379,798,809,406,395,790,803,796,401,380,399,410,407,380,803,410,379,802,415,358,799,1202,391,400,389,436,779,806,379,418,779,810,781,784,395,410,795,802,801,798,797,794,795,792,795,798,401,382,801,388,409,792,799,402,397,788,405,396,791,404,395,394,395,792,403,380,401,410,805,378,411,802,773,408,393,794,805,802,403,380,401,420,355,418,783,416,385,818,385,408,395,1186,403,398,393,396,395,396,397,396,397,396,397,396,397,392,401,392,401,392,403,392,437,358,433,378,407,1200,383,378,411,410,777,810,413,378,803,774,805,802,403,398,791,802,797,796,795,794,795,798,799,794,401,368,817,398,379,794,807,402,379,796,409,380,831,376,411,406,379,802,413,378,407,388,807,382,391,796,805,404,379,796,805,802,403,396,395,396,397,396,795,404,395,788,403,380,801,1200,411,408,355,438,779,810,379,418,777,812,779,788,395,410,795,802,799,796,795,794,799,794,797,796,397,380,795,404,379,832,775,404,393,790,407,398,791,404,395,394,395,792,407,396,397,394,793,406,377,800,805,404,395,792,803,800,401,382,401,420,355,418,783,418,385,814,385,408,793,1194,397,388,379,438,777,806,381,416,777,812,783,784,395,410,797,802,799,796,795,794,797,798,797,794,399,370,819,402,381,796,789,394,405,812,399,384,795,390,407,382,407,796,407,396,395,396,795,404,417,770,787,394,419,792,781,790,431,384,399,386,389,420,779,414,385,782,417,406,397,1184,405,398,395,396,397,396,395,394,397,394,399,394,435,356,435,358,437,358,437,358,437,358,437,356,439,1178,415,356,437,358,833,776,403,378,831,772,799,800,403,368,815,800,799,796,797,796,797,796,795,794,397,378,795,408,393,792,801,406,415,770,391,410,811,362,407,400,393,796,411,396,393,398,793,408,395,790,799,400,377,800,805,802,405,366,425,368,423,396,791,408,395,788,407,368,817,1200,395,394,395,396,785,816,385,410,779,812,779,812,389,420,783,784,789,824,795,794,793,794,795,794,399,378,797,404,379,802,807,404,395,792,407,396,791,402,379,400,411,802,377,412,405,380,805,412,377,804,777,410,393,796,803,802,403,368,423,396,393,396,791,402,379,800,411,394,793,1200,395,396,393,398,813,770,411,418,777,808,781,788,395,416,793,784,787,826,793,796,797,794,793,794,401,368,817,404,397,784,801,402,395,788,407,396,791,402,395,394,393,794,407,396,397,396,791,404,379,830,773,404,379,830,773,802,403,398,393,396,397,396,793,406,395,788,407,396,395,1182,411,396,395,396,397,396,399,394,399,394,399,392,435,358,437,358,437,358,437,358,435,358,435,388,405,1170,415,378,409,380,807,810,377,412,801,776,805,798,401,380,797,804,801,800,799,792,795,798,795,798,401,382,799,388,407,810,795,394,377,800,407,394,793,402,379,400,411,804,379,410,407,378,805,412,377,802,809,376,411,802,775,800,405,396,395,396,397,396,795,406,395,788,407,396,791,1194,379,434,379,406,803,774,383,420,783,812,785,788,395,416,793,784,823,796,793,796,795,794,793,794,401,368,817,402,395,790,801,404,397,788,401,380,795,406,379,434,379,806,379,412,409,388,805,378,393,796,805,404,395,788,799,798,403,398,393,396,397,396,793,406,393,790,405,396,793,1194,379,434,379,408,771,810,385,418,781,812,783,820,361,410,797,800,801,798,797,794,797,792,797,792,403,414,765,390,411,794,801,400,365,820,405,398,789,404,363,426,395,794,405,396,395,394,793,404,381,830,773,406,395,792,801,800,397,380,399,412,373,414,803,412,379,802,377,412,405,1202,381,380,409,410,379,414,379,412,379,410,411,382,411,380,411,380,411,412,381,412,377,424,381,398,375,1206,409,398,395,396,783,804,381,446,775,808,779,786,393,404,781,828,763,828,761,828,793,796,767,826,399,380,795,404,379,830,773,406,393,794,405,394,791,408,395,394,393,794,409,396,395,394,795,406,393,794,801,402,377,796,805,802,405,368,421,398,395,396,789,406,393,794,407,396,791,1202,395,394,393,394,807,778,411,382,803,814,783,786,395,418,791,784,821,792,795,794,797,796,793,796,399,378,797,406,415,770,789,396,417,794,389,420,785,386,409,396,395,790,407,398,393,396,791,406,395,792,801,400,379,796,805,800,403,396,395,396,395,396,791,408,395,790,407,396,791,1194,409,374,409,406,803,772,415,382,805,786,823,758,431,384,795,784,823,792,795,794,793,796,797,794,399,376,797,406,409,800,777,404,393,792,407,396,791,404,377,404,409,802,411,380,405,378,805,412,379,804,775,408,409,804,773,800,403,380,401,412,405,378,807,416,357,834,379,396,397,1184,411,394,397,396,399,394,399,394,399,394,399,394,401,392,399,412,405,380,409,380,409,380,411,410,383,1200,415,376,413,378,807,810,383,378,805,814,777,806,405,398,789,798,799,794,797,798,797,796,795,792,403,366,817,400,379,800,807,404,395,790,403,378,797,408,409,404,379,804,411,378,409,388,803,380,391,798,809,404,397,788,801,796,401,378,399,412,405,378,805,412,379,806,379,394,799,1200,395,398,391,400,817,782,385,412,811,776,813,782,391,418,791,784,785,824,791,794,797,796,795,796,403,368,815,400,377,796,805,406,393,790,405,396,791,406,393,396,395,792,407,396,395,396,795,408,395,788,803,400,379,796,805,802,401,378,399,412,407,380,803,412,379,804,379,410,803,1206,355,436,379,406,803,778,383,418,781,810,785,822,397,382,795,786,791,826,791,794,795,794,797,794,399,378,797,406,379,832,775,404,395,790,405,378,801,406,379,436,379,802,379,412,405,380,803,414,379,804,775,408,379,832,773,802,407,396,395,396,397,394,795,408,393,790,405,380,401,1202,413,380,407,380,409,380,411,410,381,410,379,410,413,378,411,380,411,380,413,380,415,390,415,386,417,1178,383,410,413,378,807,776,415,380,805,814,775,804,403,398,787,798,797,796,797,796,799,796,797,794,401,366,817,402,379,796,803,406,395,792,405,398,791,404,395,394,395,792,403,380,401,412,803,376,411,804,773,408,395,792,803,798,405,396,395,396,395,396,795,402,381,796,409,380,799,1202,411,406,379,408,801,776,383,414,809,782,789,822,399,380,799,788,789,824,795,794,795,796,795,796,397,378,795,404,381,832,773,406,395,792,407,398,789,402,379,400,409,804,377,410,407,378,805,414,377,806,775,408,393,794,805,802,403,396,391,380,403,392,795,408,379,836,379,394,793,1200,395,396,393,398,817,780,379,414,811,774,811,784,393,418,789,784,789,826,795,794,795,796,795,794,399,400,789,402,381,798,785,426,379,796,407,396,791,406,395,394,393,794,405,396,395,396,793,406,379,828,773,406,379,828,773,804,403,398,393,398,395,394,793,404,395,790,407,396,397,1184,407,396,397,396,397,394,395,412,405,380,409,380,407,380,411,410,381,410,381,410,413,378,411,380,411,1206,379,410,381,410,787,810,383,380,809,812,773,804,407,396,793,800,799,796,797,796,793,794,795,796,399,378,797,406,379,832,771,408,393,794,407,396,791,404,395,394,395,794,407,396,397,396,791,404,395,792,801,400,379,830,771,800,405,394,395,396,397,396,793,408,395,790,403,380,797,1200,411,406,379,408,805,774,383,414,807,784,789,824,365,416,795,784,791,824,791,796,795,796,795,794,403,366,819,400,379,794,803,404,379,830,377,410,769,408,411,406,379,804,379,412,407,390,805,380,391,828,773,406,393,792,801,800,399,378,399,412,405,380,807,410,377,804,377,412,801,1204,379,406,379,410,805,776,415,376,821,796,795,792,401,400,785,796,799,798,797,796,795,792,795,796,403,380,797,392,415,792,785,392,403,814,399,382,795,392,417,394,375,822,401,380,401,418,783,388,407,792,797,402,365,818,799,798,403,398,393,398,391,380,799,406,381,832,379,394,397,1216,379,394,397,394,399,394,401,392,401,392,403,392,403,392,401,422,373,392,403,424,373,392,403,392,403,1214,379,392,401,394,797,808,405,396,789,800,801,798,401,398,791,796,797,796,795,796,797,794,799,794,367,414,799,390,407,814,757,430,367,816,403,416,765,392,405,416,377,796,407,398,393,398,793,404,379,802,789,430,381,794,785,824,363,416,397,416,355,410,785,432,365,818,403,414,765,1220,379,398,383,422,773,816,383,388,805,812,771,804,405,396,793,798,795,796,797,794,799,798,765,826,401,398,789,400,365,822,801,400,365,822,403,396,789,404,363,424,393,796,403,414,371,392,797,406,381,834,773,404,395,794,797,800,401,398,393};
int samples_signal_2[LENGTH_SAMPLES_SIGNAL_2] = {1500,9175,13444,131,2386,1119,32700,165,294,97,2928,297,98,163,12328,99,794,99,230,97,132,297,164,295,100,491,100,32700,15934,361,132,263,296,559,98,99,98,5343,12282,133,268,199,232,131,132,397,100,32700,12816,197,134,197,332,165,530,1885,13078,197,858,231,824,27849,614,347,454,351,426,383,430,351,434,351,438,381,408,381,440,351,442,349,442,349,442,381,410,379,412,379,1202,381,414,379,414,807,784,393,416,791,786,791,822,361,414,795,818,759,826,793,792,795,798,795,794,401,400,785,400,379,828,771,404,379,830,377,394,791,408,393,398,393,796,405,396,397,394,795,406,395,792,799,404,395,792,799,800,401,382,403,416,357,418,785,418,383,816,385,412,775,1182,409,400,393,398,817,780,385,412,779,808,811,782,391,418,791,784,787,824,793,794,793,794,795,794,401,400,787,402,395,790,801,402,397,788,403,396,791,404,395,394,395,792,403,380,403,410,805,378,411,802,775,406,379,832,771,800,407,396,395,394,397,396,795,406,395,792,405,396,789,1198,395,396,395,398,785,816,387,410,777,810,777,812,389,416,789,784,789,824,795,794,795,794,795,794,401,398,787,402,397,788,801,402,395,788,405,396,791,404,395,396,393,792,405,380,401,410,803,378,411,802,775,410,393,792,803,802,403,366,421,378,403,410,803,378,409,806,377,412,409,1176,415,388,407,388,407,388,409,356,437,358,439,356,437,388,409,388,407,356,439,358,437,388,407,358,437,1176,415,358,437,358,833,774,407,396,791,802,799,796,403,368,819,796,797,794,799,794,795,796,793,798,401,366,819,404,397,786,799,404,397,786,403,398,787,406,395,394,395,794,405,398,395,394,793,406,395,790,803,402,377,798,803,802,401,380,399,410,407,380,803,412,377,804,411,378,803,1202,379,408,379,410,803,778,415,386,815,780,789,790,395,416,793,784,823,792,793,796,795,794,797,794,399,380,795,404,379,802,805,408,393,790,405,396,793,406,395,394,395,792,403,380,401,412,801,380,409,802,773,410,411,802,773,802,405,396,395,396,395,396,791,406,393,794,407,396,791,1198,395,396,393,398,819,782,385,410,781,810,775,812,389,418,789,784,787,824,795,794,795,794,795,796,401,368,817,404,395,788,799,404,397,786,403,398,789,404,395,394,395,792,409,396,393,396,791,404,379,798,807,404,377,798,805,802,405,396,393,396,397,394,793,406,393,794,407,396,395,1184,409,394,397,394,399,394,397,392,401,392,437,356,437,358,437,356,437,358,437,358,437,358,437,358,439,1178,415,358,435,358,833,774,407,398,789,798,797,796,399,380,795,806,797,802,797,798,795,794,797,796,399,378,793,410,393,792,801,406,397,790,405,396,787,404,377,402,409,804,415,358,433,358,831,378,409,768,807,404,379,800,805,804,403,396,393,398,393,396,793,408,395,792,405,398,787,1198,395,396,393,400,817,784,385,412,777,808,809,778,391,418,789,784,819,792,795,794,793,794,797,794,399,378,797,406,409,770,807,406,395,790,407,396,789,408,395,394,393,796,405,398,393,396,791,408,393,794,801,400,377,798,807,802,399,378,403,392,433,358,829,378,393,796,409,394,791,1202,393,396,393,398,817,778,409,384,809,774,811,784,393,418,791,782,823,760,827,796,795,796,793,794,401,368,815,402,377,796,805,404,409,768,409,378,833,378,409,372,409,806,411,378,407,380,805,414,375,806,809,378,409,770,807,802,401,378,437,358,435,358,829,380,393,796,407,398,393,1184,409,396,397,394,397,394,433,360,433,358,435,358,435,358,437,358,437,356,437,358,437,358,439,356,439,1178,413,376,407,380,805,780,409,378,833,774,803,800,405,366,819,800,795,796,795,798,795,798,795,796,401,368,819,402,397,788,799,402,397,786,405,366,821,404,399,390,397,788,405,396,395,394,795,408,395,790,799,404,377,798,805,802,403,366,425,396,395,394,795,406,397,790,403,378,797,1198,409,408,377,408,801,776,415,388,817,778,785,792,431,384,793,786,791,790,825,794,795,796,795,794,399,376,797,408,393,794,803,404,397,788,403,380,795,408,409,374,411,802,411,378,407,378,807,412,377,804,809,376,409,804,775,800,403,380,401,410,407,378,807,412,377,808,411,358,831,1172,395,398,393,398,817,778,383,416,811,774,813,780,391,418,791,784,821,792,797,794,793,794,793,796,401,366,819,404,397,790,801,400,377,796,409,394,791,408,395,396,393,794,403,380,435,378,805,378,409,806,775,406,379,800,805,800,405,396,395,394,397,394,795,406,395,792,405,378,435,1166,415,378,407,380,411,378,413,410,381,408,415,376,415,376,413,380,413,378,413,378,413,378,411,412,379,1206,407,380,405,384,803,814,377,412,811,774,809,780,391,418,791,782,821,792,795,796,793,796,795,794,403,382,797,392,405,782,823,398,369,816,403,368,819,402,397,390,379,800,409,396,395,396,793,406,379,830,773,404,379,830,773,802,405,398,393,396,397,394,795,406,395,790,403,380,799,1202,391,398,411,406,769,808,383,414,805,782,791,790,431,382,795,786,789,824,793,796,795,792,795,796,401,382,799,390,409,792,799,404,397,790,403,398,789,404,395,394,393,794,403,380,401,410,805,378,409,804,775,406,379,802,807,802,403,398,393,396,393,380,831,376,411,800,377,412,803,1170,411,410,385,408,777,806,381,416,781,812,783,786,397,416,793,784,789,822,795,798,795,794,797,794,401,368,817,398,379,796,803,404,379,798,407,412,801,378,393,398,391,796,411,394,397,396,797,406,395,792,801,404,397,788,799,798,403,396,393,398,395,394,793,404,379,796,409,380,435,1168,415,380,407,380,411,380,411,412,381,410,413,378,413,378,411,380,411,380,411,380,413,410,375,426,369,1216,397,394,395,396,785,818,387,410,779,812,777,814,385,384,821,782,785,822,795,794,795,794,793,794,399,378,795,410,393,794,803,404,397,788,405,396,789,406,395,394,395,792,407,396,395,396,793,404,379,798,805,402,381,798,803,804,405,396,393,398,395,394,795,406,395,790,403,380,797,1200,411,406,377,410,803,776,383,412,807,784,787,826,397,368,817,796,795,800,795,794,795,796,795,794,399,380,795,406,379,832,773,404,379,832,377,396,791,408,395,396,391,794,409,394,397,396,795,406,395,794,801,402,397,788,801,798,403,366,423,398,393,398,789,404,395,790,405,396,791,1202,395,396,393,398,817,784,385,410,777,810,811,778,389,410,791,800,797,800,797,796,795,794,797,796,401,382,797,390,407,778,827,400,367,816,401,366,821,402,397,394,395,790,405,396,395,394,793,408,393,792,803,402,377,796,805,804,403,366,421,380,401,410,803,378,409,804,381,394,399,1210,415,358,435,358,437,358,435,358,437,358,437,358,437,358,437,358,437,358,439,356,439,358,437,356,439,1174,417,358,437,356,833,776,405,396,791,800,801,798,401,368,815,798,799,798,797,794,793,796,795,796,403,366,817,404,397,788,799,404,395,788,405,396,791,404,395,394,395,792,403,380,433,378,801,380,409,804,775,410,393,794,803,800,399,380,399,410,405,380,807,380,409,804,411,378,803,1170,411,408,379,410,801,776,415,382,805,788,791,794,431,382,797,784,789,824,793,794,799,794,793,794,401,368,815,402,379,796,805,404,379,798,407,380,831,378,411,406,379,804,411,378,407,378,807,412,377,806,807,376,411,802,773,804,403,398,393,396,397,394,793,406,393,794,407,398,789,1198,397,394,395,396,817,782,385,412,777,804,811,780,391,418,791,784,791,792,825,796,795,794,793,796,399,378,795,410,393,794,801,404,397,788,405,396,789,406,395,394,393,794,403,380,433,378,805,378,409,804,773,412,393,794,803,796,405,398,391,398,395,394,793,406,395,792,403,378,435,1168,413,380,407,380,411,378,413,410,379,410,413,378,413,378,413,378,413,380,413,378,413,378,413,410,385,1212,387,388,419,384,811,782,415,358,835,776,799,800,399,380,795,804,799,802,797,798,793,796,797,794,397,380,793,408,379,832,773,406,395,794,405,396,793,404,397,394,393,794,403,380,401,412,801,378,411,802,773,408,411,802,773,802,403,396,395,396,397,394,793,406,395,790,407,396,791,1200,395,396,393,398,817,780,379,414,811,778,809,782,391,418,789,784,791,826,793,794,795,792,795,796,397,380,795,406,379,832,773,404,379,800,411,394,795,406,395,396,393,796,405,378,403,410,803,410,379,802,775,410,395,792,801,800,401,378,401,410,405,380,805,412,377,806,411,378,803,1206,357,434,379,406,805,774,383,414,807,784,791,822,397,382,795,786,791,826,793,796,795,794,795,792,403,380,799,390,417,790,785,392,409,796,405,396,787,406,393,396,395,794,407,396,395,394,793,408,393,794,801,400,379,796,803,800,403,378,401,412,405,380,805,410,379,804,411,378,407,1202,381,380,411,412,379,410,381,412,413,378,411,378,413,378,413,380,413,380,411,410,381,410,379,412,377,1206,415,396,383,390,807,808,385,388,805,812,773,806,403,378,797,804,799,798,797,798,797,798,797,794,401,368,819,400,377,796,803,404,395,792,405,380,795,410,393,398,391,798,407,382,401,412,803,410,377,806,773,408,395,792,801,798,403,398,393,396,397,394,793,406,395,792,407,396,791,1194,381};
int samples_signal_3[LENGTH_SAMPLES_SIGNAL_3] = {949,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,400,25000,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,400,25000,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,400,25000,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,400,25000,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,800,1200,400,400,400,400,800,800,400,400,800,800,800,800,400,400,800,800,800,800,800,800,800,800,800,800,400,400,800,400,400,800,800,400,400,800,400,400,800,400,400,400,400,800,400,400,400,400,800,400,400,800,800,400,400,800,800,800,400,400,400,400,400,400,800,400,400,800,400,400,400,25000};



SPIClass EPD_SPI(HSPI);

GxIO_Class io(EPD_SPI,  EPD_CS, EPD_DC,  EPD_RSET);
GxEPD_Class display(io, EPD_RSET, EPD_BUSY);
void LilyGo_logo();

// flag to indicate that a packet was received
volatile bool receivedFlag = false;
// disable interrupt when it's not needed
volatile bool enableInterrupt = true;

// this function is called when a complete packet
// is received by the module
// IMPORTANT: this function MUST be 'void' type
//            and MUST NOT have any arguments!
#if defined(ESP8266) || defined(ESP32)
ICACHE_RAM_ATTR
#endif

#ifdef BUTTONS
const uint8_t btns[] = BUTTONS;
#endif

void setFlag(void)
{
    // check if the interrupt is enabled
    if (!enableInterrupt) {
        return;
    }

    // we got a packet, set the flag
    receivedFlag = true;
}

void setup() 
{
  Serial.begin(115200);
  //#ifdef BUTTONS
  //  for (int i = 0; i < sizeof(btns) / sizeof(btns[0]); ++i) {
  //      pinMode(btns[i], INPUT_PULLUP);
  //  }
  //#endif
  Serial.println("Setup EPD");
  // Setup EPD
  pinMode(EPD_POWER_ENABLE, OUTPUT);
  digitalWrite(EPD_POWER_ENABLE, HIGH);
  EPD_SPI.begin(EPD_SCLK, EPD_MISO, EPD_MOSI);
  display.init(); // enable diagnostic output on Serial
  LilyGo_logo();

  // Setup Buttons
  pinMode(PIN_BTN_1, INPUT);
  pinMode(PIN_BTN_2, INPUT);
  pinMode(PIN_BTN_3, INPUT);

  //CC1101 SETUP, 315Mhz
  initCC1101(315);
  
  if (ELECHOUSE_cc1101.getCC1101()){      
    // Check the CC1101 Spi connection.
    Serial.println("Connection OK");
  }

  Serial.println("Setup done.");
}

void initCC1101(float mhz){
    ELECHOUSE_cc1101.Init();
    ELECHOUSE_cc1101.setGDO(PIN_GDO0, PIN_GDO2);
    ELECHOUSE_cc1101.setMHZ(mhz);        // Here you can set your basic frequency. The lib calculates the frequency automatically (default = 433.92).The cc1101 can: 300-348 MHZ, 387-464MHZ and 779-928MHZ. Read More info from datasheet.
    ELECHOUSE_cc1101.SetTx();               // set Transmit on
    ELECHOUSE_cc1101.setModulation(2);      // set modulation mode. 0 = 2-FSK, 1 = GFSK, 2 = ASK/OOK, 3 = 4-FSK, 4 = MSK.
    ELECHOUSE_cc1101.setDRate(512);         // Set the Data Rate in kBaud. Value from 0.02 to 1621.83. Default is 99.97 kBaud!
    ELECHOUSE_cc1101.setPktFormat(3);       // Format of RX and TX data. 0 = Normal mode, use FIFOs for RX and TX. 
                                            // 1 = Synchronous serial mode, Data in on GDO0 and data out on either of the GDOx pins. 
                                            // 2 = Random TX mode; sends random data using PN9 generator. Used for test. Works as normal mode, setting 0 (00), in RX. 
                                            // 3 = Asynchronous serial mode, Data in on GDO0 and data out on either of the GDOx pins.
  
    if(!ELECHOUSE_cc1101.getCC1101()){       // Check the CC1101 Spi connection.
      Serial.println("CC1101 Connection Error");
      display.setRotation(3);
      display.fillScreen(GxEPD_WHITE);
      display.setTextColor(GxEPD_BLACK);
      display.setCursor(0, 20);
      display.print("CC1101 Connection Error");
      display.update();
    }
}

void loop() {
  // READ BTN STATES
  int state_btn_1 = analogRead(PIN_BTN_1);
  int state_btn_2 = analogRead(PIN_BTN_2);
 // int state_btn_3 = analogRead(PIN_BTN_3);

  // BUTTON 1  
  if(state_btn_1 >= THRESHOLD_BTN_CLICK){
    while(analogRead(PIN_BTN_1) >= THRESHOLD_BTN_CLICK) {
      delay(10);
    }
    //BTN 1 CLICKED
    display.setRotation(3);
    display.fillScreen(GxEPD_WHITE);
    display.setTextColor(GxEPD_BLACK);
    display.setCursor(0, 20);
    display.print("TXing Code 1");
    display.update();

    sendSamples(samples_signal_1, LENGTH_SAMPLES_SIGNAL_1, 315);
    Serial.println("Send #1");
  }

  // BUTTON 2
  if(state_btn_2 >= THRESHOLD_BTN_CLICK){
    while(analogRead(PIN_BTN_2) >= THRESHOLD_BTN_CLICK) {
      delay(10);
    }
    //BTN 2 CLICKED
    display.setRotation(3);
    display.fillScreen(GxEPD_WHITE);
    display.setTextColor(GxEPD_BLACK);
    display.setCursor(0, 20);
    display.print("TXing Code 2");
    display.update();

    sendSamples(samples_signal_2, LENGTH_SAMPLES_SIGNAL_2, 315);
    Serial.println("Send #2");
  }
  
  /// Why doesn't Button 3 work? IT's mapped to GPIO0/ aka "Boot0" which is probably part of the issue
  // BUTTON 3
  //if(state_btn_3 >= THRESHOLD_BTN_CLICK){
  //  while(analogRead(PIN_BTN_3) >= THRESHOLD_BTN_CLICK) {
  //    delay(10);
  //  }
  //  //BTN 3 CLICKED
  //  sendSamples(samples_signal_3, LENGTH_SAMPLES_SIGNAL_3, 315);
  //  Serial.println("Send #3");
  //}
}

void LilyGo_logo(void)
{
    display.setRotation(3);
    display.fillScreen(GxEPD_WHITE);
    display.drawExampleBitmap(epd_bitmap_savant, 0, 0, GxEPD_HEIGHT, GxEPD_WIDTH, GxEPD_WHITE);
    display.update();
}

void sendSamples(int samples[], int samplesLength, float mhz) {
  initCC1101(mhz);
  //digitalWrite(PIN_LED_TX, HIGH);
  Serial.print(" Transmitting ");
  Serial.print(samplesLength);
  Serial.println(" Samples");

  int delay = 0;
  unsigned long time;
  byte n = 0;

  for (int i=0; i < samplesLength; i++) {
    // TRANSMIT
    n = 1;
    delay = samples[i];
    if(delay < 0){
      // DONT TRANSMIT
      delay = delay * -1;
      n = 0;
    }

    digitalWrite(PIN_GDO0,n);
    
    delayMicroseconds(delay);
  }

  // STOP TRANSMITTING
  digitalWrite(PIN_GDO0,0);

  Serial.println("Transmission completed.");
  display.setRotation(3);
  display.fillScreen(GxEPD_WHITE);
  display.setTextColor(GxEPD_BLACK);
  display.setCursor(0, 20);
  display.print("TX Complete!");
  display.update();
}